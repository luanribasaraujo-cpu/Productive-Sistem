<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produ√ß√£o Pro</title>
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --muted: #94a3b8;
            --accent: #38bdf8; --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --border: rgba(255, 255, 255, 0.1);
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; min-height: 100vh; }
        .hidden { display: none !important; }
        
        /* Layout */
        .top-nav { display: flex; justify-content: space-between; padding: 20px; align-items: center; border-bottom: 1px solid var(--border); background: var(--card); }
        main { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; margin-top: 20px; }

        /* Cards */
        .card-container { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; position: relative; transition: transform 0.2s; cursor: pointer; }
        .card-container:hover { transform: translateY(-5px); border-color: var(--accent); }
        .grade-badge { position: absolute; top: 12px; right: 12px; font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; z-index: 2; }
        .grade-special { background: #ef4444; color: white; } .grade-user { background: #059669; color: white; }
        .avatar { width: 100%; height: 220px; border-radius: 8px; object-fit: cover; background: #111; margin-bottom: 12px; opacity: 0.9; }
        .tags { margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap; }
        .tag { font-size: 11px; padding: 4px 8px; border-radius: 6px; background: rgba(255, 255, 255, 0.05); color: #cbd5e1; border: 1px solid var(--border); }

        /* Modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(5px); padding: 20px; }
        .modal { width: min(850px, 100%); background: var(--card); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-content { display: flex; gap: 32px; padding: 32px; }
        .thumb { width: 280px; height: 350px; border-radius: 12px; object-fit: cover; flex-shrink: 0; }
        .close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 10; }
        .close:hover { background: var(--danger); }
        .right-panel { flex: 1; width: 100%; }

        /* Inputs & Form */
        .input-group { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border); border-left: 3px solid var(--success); }
        input, select { background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        button.action-btn { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; transition: 0.2s; }
        
        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 40px; border-radius: 16px; width: 100%; max-width: 400px; border: 1px solid var(--border); text-align: center; }

        /* Timer Styles */
        .timer-wrapper { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--accent); }
        .timer-display { font-family: monospace; font-size: 1.5rem; color: var(--accent); font-weight: bold; }
        .timer-controls button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; margin-left: 5px; }
        .btn-play { background: var(--success); color: #000; }
        .btn-pause { background: var(--warning); color: #000; }
        .btn-stop { background: var(--danger); color: white; }

        /* Navbar Buttons & Tags */
        .nav-btn-secondary { background: transparent; border: 1px solid var(--muted); color: var(--muted); padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 0.9rem; transition: 0.2s; }
        .nav-btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
        
        .tag-modal-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .tag-chip { background: var(--bg); border: 1px solid var(--accent); padding: 4px 10px; border-radius: 15px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
        .tag-chip span { cursor: pointer; color: var(--danger); font-weight: bold; padding-left: 5px; }
        
        .history-tag { font-size: 0.7rem; background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: white; margin-bottom: 20px;">Portal da Equipe</h2>
            <input type="text" id="username" placeholder="Usu√°rio">
            <input type="password" id="password" placeholder="Senha">
            <button class="action-btn" onclick="fazerLogin()">Entrar</button>
            <p style="color: var(--muted); font-size: 0.8rem; margin-top: 20px;">
                Admin: <b>admin/admin</b> | User: <b>user1/1234</b>
            </p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <div class="top-nav">
            <div style="font-weight: bold;">Dashboard Pro</div>
            <div>
                <button id="btn-manage-tags" class="nav-btn-secondary hidden" onclick="toggleTagModal()">‚öôÔ∏è Tags</button>
                <button class="nav-btn-secondary" onclick="abrirModalPerfil()">üë§ Meu Perfil</button>
                <span id="welcome-msg" style="color: var(--muted); margin-right: 15px; font-size: 0.9rem;"></span>
                <button onclick="logout()" style="background:none; border:1px solid var(--danger); color:var(--danger); padding:6px 12px; border-radius:6px; cursor:pointer;">Sair</button>
            </div>
        </div>

        <main>
            <div class="grid" id="users-grid">
                </div>
        </main>
    </div>

    <div id="modal-backdrop" class="modal-backdrop hidden">
        <div class="modal">
            <button class="close" onclick="fecharModal()">√ó</button>
            <div class="modal-content">
                <img src="" id="modal-avatar" class="thumb">
                
                <div class="right-panel">
                    <h2 id="modal-name">Nome</h2>
                    <p id="modal-role" style="color: var(--accent); font-size: 0.8rem; text-transform: uppercase;">CARGO</p>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <div class="tag" style="font-size: 14px; padding: 8px 12px;">Horas: <strong id="modal-total-hours" style="color:white">00:00</strong></div>
                        <div class="tag" style="font-size: 14px; padding: 8px 12px;">Valida√ß√µes: <strong id="modal-total-qtd" style="color:white">0</strong></div>
                    </div>

                    <div id="readonly-msg" class="hidden" style="color: var(--danger); border: 1px dashed var(--danger); padding: 10px; text-align: center; border-radius: 6px; margin-bottom: 20px;">
                        üîí Apenas visualiza√ß√£o
                    </div>

                    <div id="form-container" class="input-group hidden">
                        <div class="timer-wrapper">
                            <div id="timer-display" class="timer-display">00:00:00</div>
                            <div class="timer-controls">
                                <button id="btn-start" class="btn-play" onclick="startTimer()">‚ñ∂</button>
                                <button id="btn-pause" class="btn-pause hidden" onclick="pauseTimer()">‚è∏</button>
                                <button id="btn-stop" class="btn-stop hidden" onclick="stopTimer()">‚èπ</button>
                            </div>
                        </div>

                        <select id="input-tag-select">
                            <option value="" disabled selected>-- Selecione a Atividade --</option>
                        </select>

                        <input type="text" id="input-desc" placeholder="Descri√ß√£o (Opcional)">
                        
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="input-qtd" placeholder="Qtd. Valida√ß√£o">
                            <input type="time" id="input-time" title="Para maior precis√£o, use o cron√¥metro">
                        </div>
                        <button class="action-btn" onclick="salvarAtividade()">Registrar</button>
                    </div>

                    <h4 style="color: var(--muted); border-bottom:1px solid var(--border); padding-bottom:5px;">Hist√≥rico</h4>
                    <ul id="history-list" style="list-style: none; padding: 0; max-height: 250px; overflow-y: auto;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-tags" class="modal-backdrop hidden" style="z-index: 200;">
        <div class="modal" style="width: 400px; height: auto;">
            <div style="padding: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Gerenciar Tags</h3>
                    <button onclick="toggleTagModal()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">√ó</button>
                </div>
                <div style="display: flex; gap: 5px; margin-top: 10px;">
                    <input type="text" id="new-tag-input" placeholder="Nova tag..." style="margin:0;">
                    <button onclick="addTag()" style="background: var(--success); border:none; border-radius:6px; cursor:pointer;">+</button>
                </div>
                <div id="tags-list-container" class="tag-modal-list"></div>
            </div>
        </div>
    </div>

    <div id="modal-profile" class="modal-backdrop hidden" style="z-index: 210;">
        <div class="modal" style="width: 400px; height: auto;">
            <div style="padding: 30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h3>Editar Perfil</h3>
                    <button onclick="fecharModalPerfil()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">√ó</button>
                </div>
                <label style="color:var(--muted); font-size:0.8rem">Nome de Exibi√ß√£o</label>
                <input type="text" id="edit-name">
                <label style="color:var(--muted); font-size:0.8rem">Nova Senha</label>
                <input type="text" id="edit-pass" placeholder="Digite para alterar...">
                <button class="action-btn" onclick="salvarPerfil()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <script>
        // --- DADOS INICIAIS ---
        const defaultUsers = [
            { id: 1, user: "admin", pass: "admin", name: "Administrador", role: "admin", avatar: "https://ui-avatars.com/api/?name=Admin&background=ef4444&color=fff" },
            { id: 2, user: "user1", pass: "1234", name: "Luan", role: "operador", avatar: "https://ui-avatars.com/api/?name=Luan&background=ef4444&color=fff" },
            { id: 3, user: "user2", pass: "1234", name: "Rapha", role: "operador", avatar: "https://ui-avatars.com/api/?name=Rapha&background=ef4444&color=fff" }
        ];

        let usersDB = JSON.parse(localStorage.getItem('users_db')) || defaultUsers;
        let currentUser = null;
        let selectedUserForModal = null;
        let activities = JSON.parse(localStorage.getItem('activities_db_v2')) || [];
        let availableTags = JSON.parse(localStorage.getItem('tags_db')) || ["Inspe√ß√£o Manual", "Valida√ß√£o Area Marker", "Revisao", "Daily"];
        
        let recordedPauseTime = null; 

        // --- LOGIN ---
        function fazerLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const found = usersDB.find(user => user.user === u && user.pass === p);
            if (found) {
                currentUser = found;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('welcome-msg').innerText = `${currentUser.name}`;
                if(currentUser.role === 'admin') document.getElementById('btn-manage-tags').classList.remove('hidden');
                renderGrid();
            } else { alert("Login inv√°lido."); }
        }
        function logout() { location.reload(); }

        // --- UTILIT√ÅRIOS ---
        function timeToMin(t) { 
            if(!t) return 0; 
            const parts = t.split(':').map(Number);
            const h = parts[0] || 0;
            const m = parts[1] || 0;
            return (h * 60) + m; 
        }
        
        function minToTime(m) { 
            const h = Math.floor(m / 60); 
            const mn = m % 60; 
            return `${String(h).padStart(2,'0')}h ${String(mn).padStart(2,'0')}m`; 
        }
        
        function getCurrentTime() {
            return new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // --- GRID ---
        function renderGrid() {
            const grid = document.getElementById('users-grid');
            grid.innerHTML = '';
            usersDB.forEach(user => {
                if (user.role === 'admin' && currentUser.role !== 'admin') return;
                const userActs = activities.filter(a => a.userId === user.id);
                const totalQtd = userActs.reduce((acc, c) => acc + c.qtd, 0);
                const totalMin = userActs.reduce((acc, c) => acc + timeToMin(c.time), 0);
                
                let badgeClass = user.role === 'admin' ? 'grade-special' : 'grade-user';
                let borderStyle = (currentUser && currentUser.id === user.id) ? 'border: 1px solid var(--success);' : '';

                grid.innerHTML += `
                    <div class="card-container" style="${borderStyle}" onclick="abrirModal(${user.id})">
                        <div class="grade-badge ${badgeClass}">${user.role}</div>
                        <img class="avatar" src="${user.avatar}">
                        <h3 class="name" style="margin:0">${user.name}</h3>
                        <div class="tags">
                            <span class="tag">‚è± ${minToTime(totalMin)}</span>
                            <span class="tag">üì¶ ${totalQtd}</span>
                        </div>
                    </div>
                `;
            });
        }

        // --- MODAL ---
        function abrirModal(userId) {
            const user = usersDB.find(u => u.id === userId);
            selectedUserForModal = user;
            document.getElementById('modal-backdrop').classList.remove('hidden');
            document.getElementById('modal-avatar').src = user.avatar;
            document.getElementById('modal-name').innerText = user.name;
            document.getElementById('modal-role').innerText = user.role.toUpperCase();

            const canEdit = (currentUser.role === 'admin') || (currentUser.id === user.id);
            const form = document.getElementById('form-container');
            const msg = document.getElementById('readonly-msg');

            if(canEdit) {
                form.classList.remove('hidden');
                msg.classList.add('hidden');
                updateTagSelect(); 
                resetTimer(); 
            } else {
                form.classList.add('hidden');
                msg.classList.remove('hidden');
            }
            atualizarDadosModal(canEdit);
        }

        function fecharModal() {
            document.getElementById('modal-backdrop').classList.add('hidden');
            stopTimer(); 
            renderGrid();
        }

        function atualizarDadosModal(canEdit) {
            const userActs = activities.filter(a => a.userId === selectedUserForModal.id);
            const totalQtd = userActs.reduce((acc, c) => acc + c.qtd, 0);
            const totalMin = userActs.reduce((acc, c) => acc + timeToMin(c.time), 0);
            
            document.getElementById('modal-total-hours').innerText = minToTime(totalMin);
            document.getElementById('modal-total-qtd').innerText = totalQtd;

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            [...userActs].reverse().forEach(act => {
                const btnDel = canEdit ? `<button onclick="delAct(${act.id})" style="background:none;border:none;color:#666;cursor:pointer;">‚úñ</button>` : '';
                
                // --- C√ÅLCULO DA M√âDIA SEM SEGUNDOS ---
                let rate = 0;
                
                // Quebra o tempo: HH:MM:SS
                const parts = act.time.split(':').map(Number);
                const h = parts[0] || 0;
                const m = parts[1] || 0;
                
                // L√≥gica solicitada: ignorar os segundos na matem√°tica de produtividade
                // Se trabalhou 1h 30min -> 1.5 horas
                const totalHours = h + (m/60);
                
                if (totalHours > 0) {
                    // Arredonda para n√∫mero inteiro (exato)
                    rate = Math.round(act.qtd / totalHours);
                }

                list.innerHTML += `
                    <li style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:5px; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span class="history-tag">${act.tag || 'Geral'}</span>
                            <span style="font-size:0.9rem">${act.desc || ''}</span>
                            <div style="font-size:0.75rem; color:#888;">${act.date}</div>
                        </div>
                        <div style="text-align:right">
                            <strong style="color:var(--accent)">${act.qtd} un.</strong>
                            <div style="font-size:0.9rem; font-weight:bold;">‚è± ${act.time}</div>
                            <div style="font-size:0.8rem; color:#38bdf8;">(${rate} /h)</div>
                            <div style="font-size:0.7rem; color:#888;">üõë Parou √†s: ${act.stopTime}</div>
                            ${btnDel}
                        </div>
                    </li>
                `;
            });
        }

        // --- SALVAR ATIVIDADE ---
        function salvarAtividade() {
            let tag = document.getElementById('input-tag-select').value;
            let desc = document.getElementById('input-desc').value;
            let qtd = document.getElementById('input-qtd').value;
            let manualTime = document.getElementById('input-time').value;

            let finalDuration = "00:00:00";
            
            if (seconds > 0) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                const fmt = (n) => String(n).padStart(2,'0');
                finalDuration = `${fmt(h)}:${fmt(m)}:${fmt(s)}`;
            } else if (manualTime) {
                finalDuration = manualTime;
                if(finalDuration.length === 5) finalDuration += ":00";
            }

            let finalStopTime = recordedPauseTime ? recordedPauseTime : getCurrentTime();

            if (!tag) tag = "Geral";
            if (!desc) desc = "";
            if (!qtd) qtd = 0; else qtd = Number(qtd);

            activities.push({
                id: Date.now(),
                userId: selectedUserForModal.id,
                tag, desc, qtd, 
                time: finalDuration,      
                stopTime: finalStopTime,  
                date: new Date().toLocaleDateString('pt-BR')
            });
            localStorage.setItem('activities_db_v2', JSON.stringify(activities));
            
            document.getElementById('input-desc').value = '';
            document.getElementById('input-qtd').value = '';
            document.getElementById('input-time').value = '';
            
            resetTimer(); 
            atualizarDadosModal(true);
        }

        function delAct(id) {
            if(confirm("Apagar?")) {
                activities = activities.filter(a => a.id !== id);
                localStorage.setItem('activities_db_v2', JSON.stringify(activities));
                atualizarDadosModal(true);
            }
        }

        // --- TIMER ---
        let timerInt = null;
        let seconds = 0;
        let isRunning = false;

        function updateTimerUI() {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            const fmt = (n) => String(n).padStart(2,'0');
            document.getElementById('timer-display').innerText = `${fmt(h)}:${fmt(m)}:${fmt(s)}`;
        }

        function startTimer() {
            if(isRunning) return;
            isRunning = true;
            recordedPauseTime = null; 
            document.getElementById('btn-start').classList.add('hidden');
            document.getElementById('btn-pause').classList.remove('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
            timerInt = setInterval(() => { seconds++; updateTimerUI(); }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInt);
            recordedPauseTime = getCurrentTime(); 
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-pause').classList.add('hidden');
        }

        function stopTimer() {
            pauseTimer(); 
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            document.getElementById('input-time').value = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timerInt);
            seconds = 0;
            recordedPauseTime = null;
            updateTimerUI();
            document.getElementById('btn-start').classList.remove('hidden');
            document.getElementById('btn-pause').classList.add('hidden');
            document.getElementById('btn-stop').classList.add('hidden');
        }

        // --- TAGS ---
        function updateTagSelect() {
            const sel = document.getElementById('input-tag-select');
            sel.innerHTML = '<option value="" disabled selected>-- Selecione a Atividade --</option>';
            availableTags.forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
        }
        function toggleTagModal() {
            const el = document.getElementById('modal-tags');
            if(el.classList.contains('hidden')) { el.classList.remove('hidden'); renderAdminTags(); } 
            else { el.classList.add('hidden'); updateTagSelect(); }
        }
        function renderAdminTags() {
            const container = document.getElementById('tags-list-container');
            container.innerHTML = '';
            availableTags.forEach(t => {
                container.innerHTML += `<div class="tag-chip">${t} <span onclick="removeTag('${t}')">&times;</span></div>`;
            });
        }
        function addTag() {
            const input = document.getElementById('new-tag-input');
            const val = input.value.trim();
            if(val && !availableTags.includes(val)) {
                availableTags.push(val);
                localStorage.setItem('tags_db', JSON.stringify(availableTags));
                input.value = '';
                renderAdminTags();
            }
        }
        function removeTag(tag) {
            if(confirm("Remover tag?")) {
                availableTags = availableTags.filter(t => t !== tag);
                localStorage.setItem('tags_db', JSON.stringify(availableTags));
                renderAdminTags();
            }
        }

        // --- PERFIL ---
        function abrirModalPerfil() {
            document.getElementById('modal-profile').classList.remove('hidden');
            document.getElementById('edit-name').value = currentUser.name;
            document.getElementById('edit-pass').value = currentUser.pass;
        }
        function fecharModalPerfil() { document.getElementById('modal-profile').classList.add('hidden'); }
        function salvarPerfil() {
            const newName = document.getElementById('edit-name').value;
            const newPass = document.getElementById('edit-pass').value;
            if(!newName || !newPass) return alert("Preencha todos os campos!");
            currentUser.name = newName; currentUser.pass = newPass;
            const index = usersDB.findIndex(u => u.id === currentUser.id);
            if(index !== -1) {
                usersDB[index] = currentUser;
                localStorage.setItem('users_db', JSON.stringify(usersDB));
                alert("Perfil atualizado!");
                document.getElementById('welcome-msg').innerText = currentUser.name;
                renderGrid();
                fecharModalPerfil();
            }
        }
    </script>
</body>
</html>
